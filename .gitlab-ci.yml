# GitLab CI for kahl
# Rust-only implementation

stages:
  - test

variables:
  # Disable secrets filter in CI (testing secrets filter itself)
  CLAUDE_CODE_SHELL_PREFIX: ""

test:
  stage: test
  image: rust:1.83-slim
  before_script:
    - apt-get update -qq && apt-get install -y -qq wget
    # Install yq for YAML parsing (used by generate.sh)
    - |
      YQ_VERSION="v4.50.1"
      YQ_BINARY="yq_linux_amd64"
      wget -q "https://github.com/mikefarah/yq/releases/download/${YQ_VERSION}/${YQ_BINARY}" -O /usr/local/bin/yq
      chmod +x /usr/local/bin/yq
    - mkdir -p build
  script:
    - ./generate.sh
    - cargo build --release --quiet
    - cp target/release/kahl build/kahl
    - ./test.sh
  artifacts:
    when: on_failure
    paths:
      - tests/*.log
    expire_in: 1 week
