# GitLab CI for secrets-filter
# Runs tests for each implementation and benchmarks for passing ones

stages:
  - test
  - benchmark

variables:
  # Disable secrets filter in CI (testing secrets filter itself)
  CLAUDE_CODE_SHELL_PREFIX: ""

# Common script to install test dependencies
.install_test_deps: &install_test_deps
  - |
    # Install bash, yq, bc for test.sh (Alpine or Debian)
    if command -v apk &>/dev/null; then
      apk add --no-cache bash bc wget
    elif command -v apt-get &>/dev/null; then
      apt-get update -qq && apt-get install -y -qq bc wget
    fi
    if ! command -v yq &>/dev/null; then
      YQ_VERSION="v4.50.1"
      YQ_BINARY="yq_linux_amd64"
      wget -q "https://github.com/mikefarah/yq/releases/download/${YQ_VERSION}/${YQ_BINARY}" -O /usr/local/bin/yq
      chmod +x /usr/local/bin/yq
    fi

# Template for test jobs
.test_template: &test_template
  stage: test
  before_script:
    - *install_test_deps
  script:
    - cd tests && ./test.sh -q "$IMPL"
  artifacts:
    when: on_failure
    paths:
      - tests/*.log
    expire_in: 1 week

# Python tests (reference implementation)
test:python:
  <<: *test_template
  image: python:3.12-alpine
  variables:
    IMPL: python

# Perl tests
test:perl:
  <<: *test_template
  image: perl:5.40-slim
  variables:
    IMPL: perl
  before_script:
    - apt-get update && apt-get install -y wget
    - *install_test_deps

# Ruby tests
test:ruby:
  <<: *test_template
  image: ruby:3.3-alpine
  variables:
    IMPL: ruby

# Bun tests
test:bun:
  <<: *test_template
  image: oven/bun:1.1-alpine
  variables:
    IMPL: bun

# Go tests (requires build)
test:go:
  <<: *test_template
  image: golang:1.23-alpine
  variables:
    IMPL: go
  before_script:
    - *install_test_deps
    - cd go && go build -ldflags="-s -w" -o secrets-filter secrets-filter.go patterns_gen.go

# Rust tests (requires build)
test:rust:
  <<: *test_template
  image: rust:1.83-alpine
  variables:
    IMPL: rust
  before_script:
    - apk add --no-cache musl-dev
    - *install_test_deps
    - cd rust && cargo build --release && cp target/release/secrets-filter .

# Swift tests (requires build)
test:swift:
  <<: *test_template
  image: swift:6.0
  variables:
    IMPL: swift
  before_script:
    - apt-get update && apt-get install -y wget
    - *install_test_deps
    - cd swift && swiftc -O -o secrets-filter main.swift

# Benchmark job - runs only for passing implementations
benchmark:
  stage: benchmark
  image: python:3.12-alpine
  needs:
    - job: test:python
      optional: true
    - job: test:perl
      optional: true
    - job: test:ruby
      optional: true
    - job: test:bun
      optional: true
  before_script:
    - apk add --no-cache perl ruby bash bc wget
    # Install bun
    - wget -q https://bun.sh/install -O - | BUN_INSTALL=/usr/local bash
    - *install_test_deps
  script:
    - cd tests
    # Generate corpus if needed
    - chmod +x corpus/generate-corpus.sh && ./corpus/generate-corpus.sh
    # Run benchmarks for scripting languages (always available)
    - ./bench.sh 20 python
    - ./bench.sh 20 perl
    - ./bench.sh 20 ruby
    - ./bench.sh 20 bun
    - echo "=== Benchmark Results ==="
    - cat benchmark-results.csv
  artifacts:
    paths:
      - tests/benchmark-results.csv
    expire_in: 1 month
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
